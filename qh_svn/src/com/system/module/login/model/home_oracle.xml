<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="home">
	<select id="getUserValInfo" parameterType="java.lang.Object" resultType="com.frame.common.BaseMap">
		SELECT A.INDI_NAME reach_name,
			   nvl(SUM(A.INDI_NUM), 0) user_val
		  FROM TB_OTHER_INDI_DATA A,
		  	   TB_LARGE_AREA F
		 WHERE A.INDI_ID = 2
		   AND A.AREA = F.AREA_ID
		   AND A.DAY_ID IN
		       (SELECT MAX(DAY_ID) FROM TB_OTHER_INDI_DATA WHERE INDI_ID = 2)
		   AND EXISTS (SELECT 1
		          FROM TB_LARGE_USER_AREA_REL F
		         WHERE A.AREA = F.AREA_ID
		           AND F.USER_ID = #{userId})
		<if test="latnName!=null and latnName!=''">
		   AND EXISTS (SELECT 1
		          FROM TB_LARGE_AREA G
		         WHERE G.AREA_LEVEL = 3
		           AND G.AREA_NAME = #{latnName}
		           AND G.AREA_ID = F.PARENT_AREA)
		</if>
		 GROUP BY A.INDI_NAME
    </select>
	<select id="getWingPayValInfo" parameterType="java.lang.Object" resultType="com.frame.common.BaseMap"> 
		 SELECT nvl(round(sum(a.consume_charge), 0), 0) money_val,
		        nvl(SUM(A.consume_number), 0) count_val
		   FROM TB_LARGE_BESTPAY_CONSUME A,
		        VW_LOC_AREA              B,
		        VW_LOC_AREA              C,
		        TB_LARGE_AREA            F
		  WHERE A.DAY_ID = (SELECT MAX(DAY_ID) FROM TB_LARGE_BESTPAY_CONSUME)
		    AND A.LATN_ID = B.ZONE_NUMBER
		    AND B.AREA_LEVEL = 3
		    AND A.AREA_ID = C.AREA_ID
		    AND A.AREA_ID = F.AREA_ID
		    AND C.AREA_LEVEL = 4
		    AND EXISTS (SELECT 1
		           FROM TB_LARGE_USER_AREA_REL F
		          WHERE A.AREA_ID = F.AREA_ID
		            AND F.USER_ID = #{userId})
	     <if test="latnName!=null and latnName!=''">
	        AND EXISTS (SELECT 1
	               FROM TB_LARGE_AREA G
	              WHERE G.AREA_LEVEL = 3
	                AND G.AREA_NAME = #{latnName}
	                AND G.AREA_ID = F.PARENT_AREA)
	     </if>
    </select>
	<select id="getRoamValInfo" parameterType="java.lang.Object" resultType="com.frame.common.BaseMap"> 
		SELECT nvl(SUM(USER_NUM), 0) roam_val
		  FROM DM_OSS_VISIT_OTHER_AREA_DAY T
		 WHERE FLAG in (1)
		   AND DATE_NO = (SELECT max(date_no)
		                    FROM DM_OSS_VISIT_OTHER_AREA_DAY
		                   WHERE FLAG in (1))
	     <if test="latnName!=null and latnName!=''">
	       AND EXISTS (SELECT 1
	                      FROM TB_LARGE_AREA G
	                     WHERE G.AREA_LEVEL = 3
	                       AND G.AREA_NAME = #{latnName}
	                       AND G.ZONE_NUMBER = T.VISIT_LATN_ID)
	     </if>
		   AND EXISTS (SELECT 1
		          FROM TB_LARGE_USER_AREA_REL F
		         WHERE T.VISIT_LATN_ID = F.LATN_ID
		           AND F.USER_ID = #{userId})
    </select>
	<select id="getItvValInfo" parameterType="java.lang.Object" resultType="com.frame.common.BaseMap">
		SELECT count(a.prod_inst_id) itv_val
		  FROM DM_PRD_ITV_INST a, VW_LOC_AREA B, VW_LOC_AREA C, TB_LARGE_AREA F
		 WHERE A.Zone_Number = B.ZONE_NUMBER
		   AND B.AREA_LEVEL = 3
		   AND A.AREA_ID = C.AREA_ID
		   AND A.AREA_ID = F.AREA_ID
		   AND C.AREA_LEVEL = 4
		   and a.day_id = (SELECT max(day_id) FROM DM_PRD_ITV_INST)
		   AND EXISTS (SELECT 1
		          FROM TB_LARGE_USER_AREA_REL F
		         WHERE a.zone_number = F.LATN_ID
		           AND F.USER_ID = #{userId})
		<if test="latnName!=null and latnName!=''">
		   AND EXISTS (SELECT 1
		          FROM TB_LARGE_AREA G
		         WHERE G.AREA_LEVEL = 3
		           AND G.AREA_NAME = #{latnName}
		           AND G.AREA_ID = F.PARENT_AREA)
		</if>
    </select>
	<select id="getWingPayInfo" parameterType="java.lang.Object" resultType="com.frame.common.BaseMap"> 
		SELECT A.pay_type,
		       NVL(ROUND(SUM(A.sum_value) / SUM(B.sum_value) * 100, 0), 0) pay_rate
		  from (SELECT A.PARTNER_TYPE pay_type,
		               nvl(SUM(A.consume_number), 0) sum_value
		          FROM TB_LARGE_BESTPAY_CONSUME A,
		               VW_LOC_AREA              B,
		               VW_LOC_AREA              C,
		               TB_LARGE_AREA            F
		         WHERE A.DAY_ID = (SELECT MAX(DAY_ID) FROM TB_LARGE_BESTPAY_CONSUME)
		           AND A.LATN_ID = B.ZONE_NUMBER
		           AND B.AREA_LEVEL = 3
		           AND A.AREA_ID = C.AREA_ID
		           AND A.AREA_ID = F.AREA_ID
		           AND C.AREA_LEVEL = 4
	     		<if test="latnName!=null and latnName!=''">
				   AND EXISTS (SELECT 1
	              FROM TB_LARGE_AREA G
	             WHERE G.AREA_LEVEL = 3
	               AND G.AREA_NAME = #{latnName}
	               AND G.AREA_ID = F.PARENT_AREA)
	     		</if>
		           AND EXISTS (SELECT 1
		                  FROM TB_LARGE_USER_AREA_REL F
		                 WHERE A.AREA_ID = F.AREA_ID
		                   AND F.USER_ID = #{userId})
		         GROUP BY A.PARTNER_TYPE
		         ORDER BY SUM_VALUE) A,
		       (SELECT nvl(SUM(A.consume_number), 0) sum_value
		          FROM TB_LARGE_BESTPAY_CONSUME A,
		               VW_LOC_AREA              B,
		               VW_LOC_AREA              C,
		               TB_LARGE_AREA            F
		         WHERE A.DAY_ID = (SELECT MAX(DAY_ID) FROM TB_LARGE_BESTPAY_CONSUME)
		           AND A.LATN_ID = B.ZONE_NUMBER
		           AND B.AREA_LEVEL = 3
		           AND A.AREA_ID = C.AREA_ID
		           AND A.AREA_ID = F.AREA_ID
		           AND C.AREA_LEVEL = 4
	     		<if test="latnName!=null and latnName!=''">
				   AND EXISTS (SELECT 1
	              FROM TB_LARGE_AREA G
	             WHERE G.AREA_LEVEL = 3
	               AND G.AREA_NAME = #{latnName}
	               AND G.AREA_ID = F.PARENT_AREA)
	     		</if>
		           AND EXISTS (SELECT 1
		                  FROM TB_LARGE_USER_AREA_REL F
		                 WHERE A.AREA_ID = F.AREA_ID
		                   AND F.USER_ID = #{userId})) B
		 GROUP BY A.pay_type
    </select>
	<select id="getRoamInfo" parameterType="java.lang.Object" resultType="com.frame.common.BaseMap"> 
		SELECT USER_PROV_NAME roam_name,
			   USER_NUM roam_val
		  FROM (SELECT CASE
		                 WHEN USER_PROV_NAME NOT LIKE '内蒙古%' AND
		                      USER_PROV_NAME NOT LIKE '黑龙江%' THEN
		                  SUBSTR(USER_PROV_NAME, 1, 2)
		                 ELSE
		                  SUBSTR(USER_PROV_NAME, 1, 3)
		               END USER_PROV_NAME,
		               SUBSTR(VISIT_PROV_NAME, 1, 2) VISIT_PROV_NAME,
		               nvl(SUM(USER_NUM), 0) USER_NUM,
		               ROW_NUMBER() OVER(ORDER BY nvl(SUM(USER_NUM), 0) DESC) RN
		          FROM DM_OSS_VISIT_OTHER_AREA_DAY T
		         WHERE FLAG = 1
		           AND DATE_NO = (SELECT max(date_NO) FROM DM_OSS_VISIT_OTHER_AREA_DAY WHERE FLAG = 1 )
		           AND EXISTS (SELECT 1
		                  FROM TB_LARGE_USER_AREA_REL F
		                 WHERE T.VISIT_LATN_ID = F.LATN_ID
		                   AND F.USER_ID = #{userId})
				<if test="latnName!=null and latnName!=''">
	               AND EXISTS (SELECT 1
	                      FROM TB_LARGE_AREA G
	                     WHERE G.AREA_LEVEL = 3
	                       AND G.AREA_NAME = #{latnName}
	                       AND G.ZONE_NUMBER = T.VISIT_LATN_ID)
				</if>
		         GROUP BY CASE
		                    WHEN USER_PROV_NAME NOT LIKE '内蒙古%' AND
		                         USER_PROV_NAME NOT LIKE '黑龙江%' THEN
		                     SUBSTR(USER_PROV_NAME, 1, 2)
		                    ELSE
		                     SUBSTR(USER_PROV_NAME, 1, 3)
		                  END,
		                  SUBSTR(VISIT_PROV_NAME, 1, 2))
		 WHERE RN &lt; 11
    </select>
</mapper>